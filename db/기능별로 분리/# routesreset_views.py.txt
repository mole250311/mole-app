# routes/reset_views.py

from flask import Blueprint, request, jsonify, current_app
from relay import reset_service # relay í´ë”ì˜ ì„œë¹„ìŠ¤ íŒŒì¼ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
import re

bp = Blueprint('reset', __name__, url_prefix='/reset')

EMAIL_REGEX = re.compile(r"^[a-zA-Z0-9.+_-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$")

# --- ğŸš€ 1ë‹¨ê³„: ì¸ì¦ ì½”ë“œ ìš”ì²­ API ---
@bp.route('/request-password', methods=['POST'])
def request_password_reset():
    DB_CONFIG = current_app.config['DB_CONFIG']
    MAIL_PROVIDERS = current_app.config['MAIL_PROVIDERS']
    ACTIVE_PROVIDER_NAME = current_app.config['ACTIVE_PROVIDER_NAME']
    ACTIVE_PROVIDER = MAIL_PROVIDERS[ACTIVE_PROVIDER_NAME]
    
    data = request.get_json()
    if not data or 'email' not in data:
        return jsonify(error="ìš”ì²­ ë³¸ë¬¸ì— 'email' í•„ë“œê°€ í•„ìš”í•©ë‹ˆë‹¤."), 400
    
    email = data['email']
    if not EMAIL_REGEX.match(email):
        return jsonify(error="ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë©”ì¼ í˜•ì‹ì…ë‹ˆë‹¤."), 400

    result = reset_service.request_reset_code(email, DB_CONFIG, ACTIVE_PROVIDER)

    if result['status'] == 'success':
        return jsonify(message="ìš”ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤. ê°€ì…ëœ ì´ë©”ì¼ì´ë¼ë©´ ì½”ë“œê°€ ë°œì†¡ë©ë‹ˆë‹¤."), 200
    else:
        return jsonify(error=result['message']), 500

# --- ğŸš€ 2ë‹¨ê³„: ì¸ì¦ ì½”ë“œ ê²€ì¦ API ---
@bp.route('/verify-code', methods=['POST'])
def verify_reset_code():
    DB_CONFIG = current_app.config['DB_CONFIG']
    data = request.get_json()
    if not data or 'email' not in data or 'code' not in data:
        return jsonify(error="ìš”ì²­ ë³¸ë¬¸ì— 'email'ê³¼ 'code' í•„ë“œê°€ ëª¨ë‘ í•„ìš”í•©ë‹ˆë‹¤."), 400

    email = data['email']
    user_code = data['code']

    result = reset_service.verify_code_only(email, user_code, DB_CONFIG)

    if result['status'] == 'success':
        return jsonify(message="ì¸ì¦ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤."), 200
    elif result['status'] == 'fail':
        return jsonify(error=result['message']), 400
    else: # 'error'
        return jsonify(error=result['message']), 500

# --- ğŸš€ 3ë‹¨ê³„: ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì„¤ì • API ---
@bp.route('/reset-password', methods=['POST'])
def reset_password_with_code():
    DB_CONFIG = current_app.config['DB_CONFIG']
    data = request.get_json()
    if not data or 'email' not in data or 'code' not in data or 'new_password' not in data:
        return jsonify(error="ìš”ì²­ ë³¸ë¬¸ì— 'email', 'code', 'new_password' í•„ë“œê°€ ëª¨ë‘ í•„ìš”í•©ë‹ˆë‹¤."), 400

    email = data['email']
    user_code = data['code']
    new_password = data['new_password']

    if len(new_password) < 6:
        return jsonify(error="ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤."), 400

    result = reset_service.update_password_with_code(email, user_code, new_password, DB_CONFIG)

    if result['status'] == 'success':
        return jsonify(message="ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤."), 200
    elif result['status'] == 'fail':
        return jsonify(error=result['message']), 400
    else: # 'error'
        return jsonify(error=result['message']), 500
