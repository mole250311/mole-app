from flask import Flask, request, jsonify
import smtplib
from email.mime.text import MIMEText
import random
import mysql.connector
import re
import hashlib
import base64
import os

# --- Flask ì•± ì´ˆê¸°í™” ---
app = Flask(__name__)

# --- 1. ì„œë²„ ì„¤ì • (PyCharm í…ŒìŠ¤íŠ¸ìš©) ---
# âš ï¸ ì¤‘ìš”: ì´ ë¶€ë¶„ì— ë‹¹ì‹ ì˜ ì‹¤ì œ ì •ë³´ë¥¼ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”.
# ì‹¤ì œ ì„œë¹„ìŠ¤ ë°°í¬ ì‹œì—ëŠ” ë³´ì•ˆì„ ìœ„í•´ .env íŒŒì¼ì„ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
MAIL_PROVIDERS = {
    'gmail': {
        'server': "smtp.gmail.com", 
        'port': 587,
        'user': "YOUR_GMAIL_ADDRESS@gmail.com",      # ì—¬ê¸°ì— ë‹¹ì‹ ì˜ Gmail ì£¼ì†Œ ì…ë ¥
        'password': "YOUR_GMAIL_16_DIGIT_APP_PASSWORD" # ì—¬ê¸°ì— ë‹¹ì‹ ì˜ Gmail ì•± ë¹„ë°€ë²ˆí˜¸ ì…ë ¥
    },
    'naver': {
        'server': "smtp.naver.com", 
        'port': 587,
        'user': "YOUR_NAVER_ADDRESS@naver.com",      # ì—¬ê¸°ì— ë‹¹ì‹ ì˜ ë„¤ì´ë²„ ì£¼ì†Œ ì…ë ¥
        'password': "YOUR_NAVER_APP_PASSWORD"         # ì—¬ê¸°ì— ë‹¹ì‹ ì˜ ë„¤ì´ë²„ ì•± ë¹„ë°€ë²ˆí˜¸ ì…ë ¥
    }
}
# ê¸°ë³¸ìœ¼ë¡œ ì‚¬ìš©í•  ì´ë©”ì¼ ì„œë¹„ìŠ¤ë¥¼ ì„ íƒí•©ë‹ˆë‹¤.
ACTIVE_PROVIDER_NAME = 'gmail'
ACTIVE_PROVIDER = MAIL_PROVIDERS[ACTIVE_PROVIDER_NAME]

# ë°ì´í„°ë² ì´ìŠ¤ ì ‘ì† ì •ë³´
DB_CONFIG = {
    'host': '127.0.0.1', 
    'database': 'NuSchema',
    'user': 'root', 
    'password': 'YOUR_MYSQL_PASSWORD' # ì—¬ê¸°ì— ë‹¹ì‹ ì˜ MySQL ë¹„ë°€ë²ˆí˜¸ ì…ë ¥
}
# ---------------------------------------------------------

EMAIL_REGEX = re.compile(r"^[a-zA-Z0-9.+_-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$")

def hash_password(password):
    """ë¹„ë°€ë²ˆí˜¸ë¥¼ í•´ì‹±í•˜ê³  Saltë¥¼ ìƒì„±í•©ë‹ˆë‹¤."""
    salt_bytes = os.urandom(16)
    hashed_bytes = hashlib.pbkdf2_hmac('sha256', password.encode('utf-8'), salt_bytes, 100000, dklen=32)
    salt_str = base64.b64encode(salt_bytes).decode('utf-8')
    hashed_str = base64.b64encode(hashed_bytes).decode('utf-8')
    return salt_str, hashed_str

# --- ğŸš€ 1ë‹¨ê³„: ì¸ì¦ ì½”ë“œ ìš”ì²­ API ---
@app.route('/request-password-reset', methods=['POST'])
def request_password_reset():
    """ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •ì„ ìœ„í•œ ì¸ì¦ ì½”ë“œë¥¼ ë°œì†¡í•©ë‹ˆë‹¤."""
    data = request.get_json()
    if not data or 'email' not in data:
        return jsonify({"error": "ìš”ì²­ ë³¸ë¬¸ì— 'email' í•„ë“œê°€ í•„ìš”í•©ë‹ˆë‹¤."}), 400
    
    email = data['email']
    if not EMAIL_REGEX.match(email):
        return jsonify({"error": "ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë©”ì¼ í˜•ì‹ì…ë‹ˆë‹¤."}), 400

    try:
        conn = mysql.connector.connect(**DB_CONFIG)
        cursor = conn.cursor()

        cursor.execute("SELECT user_id FROM users WHERE email = %s", (email,))
        if not cursor.fetchone():
            print(f"ê°€ì…ë˜ì§€ ì•Šì€ ì´ë©”ì¼ë¡œ ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì‹œë„: {email}")
            return jsonify({"message": "ìš”ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤. ê°€ì…ëœ ì´ë©”ì¼ì´ë¼ë©´ ì½”ë“œê°€ ë°œì†¡ë©ë‹ˆë‹¤."}), 200

        auth_code = str(random.randint(100000, 999999))
        save_query = "INSERT INTO auth_codes (email, code, created_at) VALUES (%s, %s, CURRENT_TIMESTAMP) ON DUPLICATE KEY UPDATE code = VALUES(code), created_at = CURRENT_TIMESTAMP"
        cursor.execute(save_query, (email, auth_code))
        conn.commit()

    except mysql.connector.Error as err:
        print(f"ë°ì´í„°ë² ì´ìŠ¤ ì˜¤ë¥˜: {err}")
        return jsonify({"error": "ì„œë²„ ë°ì´í„°ë² ì´ìŠ¤ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."}), 500
    finally:
        if 'conn' in locals() and conn.is_connected(): cursor.close(); conn.close()

    try:
        msg_body = f"ì•ˆë…•í•˜ì„¸ìš”.\n\nìš”ì²­í•˜ì‹  ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì¸ì¦ ì½”ë“œëŠ” [{auth_code}] ì…ë‹ˆë‹¤."
        msg = MIMEText(msg_body)
        msg['Subject'] = "[ë‚´ ì•± ì´ë¦„] ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì½”ë“œ ì•ˆë‚´"
        msg['From'] = ACTIVE_PROVIDER['user']
        msg['To'] = email
        with smtplib.SMTP(ACTIVE_PROVIDER['server'], ACTIVE_PROVIDER['port']) as server:
            server.starttls(); server.login(ACTIVE_PROVIDER['user'], ACTIVE_PROVIDER['password']); server.send_message(msg)
    except Exception as e:
        print(f"ì´ë©”ì¼ ë°œì†¡ ì˜¤ë¥˜: {e}")
        return jsonify({"error": "ì´ë©”ì¼ ë°œì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."}), 500

    return jsonify({"message": "ìš”ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤. ê°€ì…ëœ ì´ë©”ì¼ì´ë¼ë©´ ì½”ë“œê°€ ë°œì†¡ë©ë‹ˆë‹¤."}), 200

# --- ğŸš€ 2ë‹¨ê³„: ì¸ì¦ ì½”ë“œ ê²€ì¦ API ---
@app.route('/verify-reset-code', methods=['POST'])
def verify_reset_code():
    """ë°œì†¡ëœ ì¸ì¦ ì½”ë“œê°€ ìœ íš¨í•œì§€ ê²€ì¦ë§Œ í•©ë‹ˆë‹¤."""
    data = request.get_json()
    if not data or 'email' not in data or 'code' not in data:
        return jsonify({"error": "ìš”ì²­ ë³¸ë¬¸ì— 'email'ê³¼ 'code' í•„ë“œê°€ ëª¨ë‘ í•„ìš”í•©ë‹ˆë‹¤."}), 400

    email = data['email']
    user_code = data['code']

    try:
        conn = mysql.connector.connect(**DB_CONFIG)
        cursor = conn.cursor()
        verify_query = "SELECT email FROM auth_codes WHERE email = %s AND code = %s AND created_at > NOW() - INTERVAL 5 MINUTE"
        cursor.execute(verify_query, (email, user_code))
        
        if cursor.fetchone():
            return jsonify({"message": "ì¸ì¦ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤."}), 200
        else:
            return jsonify({"error": "ì¸ì¦ ì½”ë“œê°€ ìœ íš¨í•˜ì§€ ì•Šê±°ë‚˜ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤."}), 400
    except mysql.connector.Error as err:
        print(f"ë°ì´í„°ë² ì´ìŠ¤ ì˜¤ë¥˜: {err}")
        return jsonify({"error": "ì„œë²„ ë°ì´í„°ë² ì´ìŠ¤ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."}), 500
    finally:
        if 'conn' in locals() and conn.is_connected(): cursor.close(); conn.close()

# --- ğŸš€ 3ë‹¨ê³„: ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì„¤ì • API ---
@app.route('/reset-password-with-code', methods=['POST'])
def reset_password_with_code():
    """ì¸ì¦ ì½”ë“œë¥¼ ë‹¤ì‹œ ê²€ì¦í•˜ê³  ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¡œ ìµœì¢… ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤."""
    data = request.get_json()
    if not data or 'email' not in data or 'code' not in data or 'new_password' not in data:
        return jsonify({"error": "ìš”ì²­ ë³¸ë¬¸ì— 'email', 'code', 'new_password' í•„ë“œê°€ ëª¨ë‘ í•„ìš”í•©ë‹ˆë‹¤."}), 400

    email = data['email']
    user_code = data['code']
    new_password = data['new_password']

    if len(new_password) < 6:
        return jsonify({"error": "ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤."}), 400

    try:
        conn = mysql.connector.connect(**DB_CONFIG)
        cursor = conn.cursor()

        verify_query = "SELECT email FROM auth_codes WHERE email = %s AND code = %s AND created_at > NOW() - INTERVAL 5 MINUTE"
        cursor.execute(verify_query, (email, user_code))
        if not cursor.fetchone():
            return jsonify({"error": "ì¸ì¦ ì½”ë“œê°€ ìœ íš¨í•˜ì§€ ì•Šê±°ë‚˜ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤."}), 400
        
        new_salt, new_hashed_password = hash_password(new_password)
        update_query = "UPDATE users SET password = %s, salt = %s WHERE email = %s"
        cursor.execute(update_query, (new_hashed_password, new_salt, email))
        
        delete_query = "DELETE FROM auth_codes WHERE email = %s"
        cursor.execute(delete_query, (email,))
        conn.commit()
        
        return jsonify({"message": "ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤."}), 200

    except mysql.connector.Error as err:
        print(f"ë°ì´í„°ë² ì´ìŠ¤ ì˜¤ë¥˜: {err}")
        return jsonify({"error": "ì„œë²„ ë°ì´í„°ë² ì´ìŠ¤ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."}), 500
    finally:
        if 'conn' in locals() and conn.is_connected(): cursor.close(); conn.close()

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000, debug=True)
